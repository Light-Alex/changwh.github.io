---
layout: post
title:  "CTPN论文的阅读与学习"
date:   2019-06-02 12:00:00 +0800
categories: cv
tags: CTPN
author: ac酱
mathjax: true
---

* content
{:toc}
最近在项目中使用了CTPN及CRNN进行中文OCR系统的构造，因此很有必要对这两个网络进行更进一步的了解与学习。本文将记录与CTPN相关的内容。



## CTPN流程概括

<center>
<img src="https://raw.githubusercontent.com/changwh/changwh.github.io/master/_posts/res/2019-06-02-ctpn-paper-reading/architecture.jpg" />
<div>CTPN整体结构</div>
</center>

<center>
<img src="https://raw.githubusercontent.com/changwh/changwh.github.io/master/_posts/res/2019-06-02-ctpn-paper-reading/model_code.jpg" />
<div>代码实现</div>
</center>


* 以VGG16为前置网络，用于输入图片的特征提取，使用经过其最后一个卷积层（VGG论文中conv3-512）得到的特征图，大小为W\*H\*C
* 在特征图的每个像素点上使用3\*3\*C的滑动窗口提取进一步特征，用于RPN
* 每一行像素通过滑动窗口处理后得到的特征（W\*3\*3\*C）作为256维BLSTM（包含两个128维的LSTM）的输入
* 将BLSTM的输出作为512维全连接层的输入
* 全连接层之后紧接着输出层，输出层包含三个分类或是回归。第二个2k scores表示的是k个anchor的类别信息（是否是字符）。第一个2k vertical coordinates（表示bounding box的高度和中心的y轴坐标，可决定上下边界）和第三个k side-refinement（表示bounding box的水平平移量，但在这里默认的宽度是固定的16像素）用来回归k个anchor的位置信息
* 通过简单的文本线构造算法，把分类得到的文字的proposal合并成文本线

## 关键的IDEA

### 锚点机制

CTPN通过在卷积特征图中密集地滑动小窗口来检测文本行，并且输出一系列细粒度（如宽度固定为16像素）的文本提议。当前置网络为VGG16时，滑动窗口的总步长和感受野分别为16（经过4次池化）和228像素（相当于VGG16最后一层之后又进行一次3\*3，stride=1的卷积，参见[感受野的计算](https://www.cnblogs.com/objectDetect/p/5947169.html)）。

通常滑动窗口采用多尺度窗口来检测不同尺寸的目标，其中一个窗口尺度被固定到与目标的尺寸相似。而锚点回归机制，允许RPN使用单尺度窗口检测多尺度目标。关键的见解是单个窗口能够通过使用多个灵活的锚点来预测各种尺度和长宽比的目标。

但是文本与普通目标不同，没有一个明显封闭的边界，不能从一部分推断整个目标。因为文本中的每个字符都是独立或分离的，所以查找文本的开始和结束位置十分困难。但是文本又是一个序列，因此可以很自然地将其视为一系列文本细粒度文本提议，每个提议都是文本行的一小部分，它可能包含单个或多个笔画，单个或多个字符，或是字符的一部分。

显然，文本行的垂直位置相对于水平位置是更容易预测的，因此将水平位置固定，来预测其垂直位置会更准确。这与预测物体的4个坐标的RPN相比，减少了搜索空间。

基于以上原因，CTPN采用了垂直锚点机制，可以同时预测每个细粒度提议的文本/非文本分数和y轴坐标。

细粒度的文本提议的具体设计如下。由于使用了VGG16的最后一个卷积特征图，并在其上进行大小为3\*3，步长为1的滑动窗口提取特征。这对于原图像来说，总步长为16像素，因此文本提议的固定宽度被设置为16像素。之后需要设计k个垂直锚点来预测每个提议的y坐标。k个锚点具有相同的水平位置，固定宽度为16像素，但其垂直位置在k个不同的高度变化。
### 网内循环架构

### 文本线构造算法

## 文中提及的相关工作

### RPN



**to be continued**
